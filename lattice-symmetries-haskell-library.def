Bootstrap: localimage
From: lattice-symmetries-haskell.sif

%post -c /bin/bash
    set -eu
    set -o pipefail

    # Building C++ code
    cd /lattice-symmetries
    git pull origin master
    cmake -DBUILD_SHARED_LIBS=ON -S . -B build
    cmake --build build --target install
    rm -f prefix/lib/liblattice_symmetries.a

    # Building Haskell code
    cd /lattice-symmetries-haskell
    git pull origin main
    export PKG_CONFIG_PATH=/lattice-symmetries/prefix/lib/pkgconfig
    export GHCUP_INSTALL_BASE_PREFIX=/opt
    export CABAL_DIR=/opt/.cabal
    export PATH="$CABAL_DIR/.cabal/bin:$GHCUP_INSTALL_BASE_PREFIX/.ghcup/bin:$PATH"
    cabal new-build
    make shared static

    # Creating a "release"
    mkdir /release
    cp -r /lattice-symmetries/prefix/include /release/
    cp -r /lattice-symmetries/prefix/lib /release/
    cp cbits/lattice_symmetries_haskell.h /release/include/
    cp build/liblattice_symmetries_haskell.so /release/lib/
